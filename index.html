<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spotify Music App</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 30px;
  }
  #songList li {
    cursor: pointer;
    margin: 5px 0;
  }
</style>
</head>
<body>

<h1>Spotify Music App</h1>
<button id="loginBtn">Login with Spotify</button>
<div id="userInfo"></div>

<input type="search" id="searchInput" placeholder="Search songs..." style="width:300px; margin-top: 20px;" />
<ul id="songList"></ul>

<audio id="audioPlayer" controls style="width: 100%; margin-top: 20px;"></audio>

<script>
  const loginBtn = document.getElementById('loginBtn');
  const userInfo = document.getElementById('userInfo');
  const searchInput = document.getElementById('searchInput');
  const songList = document.getElementById('songList');
  const audioPlayer = document.getElementById('audioPlayer');

  const params = new URLSearchParams(window.location.search);
  let accessToken = params.get('access_token');
  let refreshToken = params.get('refresh_token');
  let expiresIn = params.get('expires_in');

  if (accessToken) {
    loginBtn.style.display = 'none';
    fetchUserProfile();
  }

  loginBtn.onclick = () => {
    window.location.href = 'http://localhost:3000/login';
  };

  async function fetchUserProfile() {
    try {
      const res = await fetch('https://api.spotify.com/v1/me', {
        headers: { Authorization: 'Bearer ' + accessToken },
      });
      const data = await res.json();
      userInfo.textContent = `Logged in as ${data.display_name}`;
    } catch (err) {
      userInfo.textContent = 'Failed to fetch user profile';
    }
  }

  searchInput.oninput = async () => {
    const query = searchInput.value.trim();
    if (!query) {
      songList.innerHTML = '';
      return;
    }
    try {
      const res = await fetch(
        `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`,
        { headers: { Authorization: 'Bearer ' + accessToken } }
      );
      const data = await res.json();
      songList.innerHTML = '';
      data.tracks.items.forEach(track => {
        const li = document.createElement('li');
        li.textContent = `${track.name} â€” ${track.artists.map(a => a.name).join(', ')}`;
        li.onclick = () => {
          if (track.preview_url) {
            audioPlayer.src = track.preview_url;
            audioPlayer.play();
          } else {
            alert('No preview available for this track.');
          }
        };
        songList.appendChild(li);
      });
    } catch (err) {
      songList.innerHTML = '<li>Error searching songs.</li>';
    }
  };
</script>

</body>
</html>
